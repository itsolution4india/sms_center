<!DOCTYPE html>
<html>
<head>
    <title>Analytics for {{ username }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h3 class="mb-4">SMS Analytics for <span id="username">{{ username }}</span></h3>
        
        <!-- Date Filter -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <label for="dateFilter" class="form-label">Select Date:</label>
                        <input type="date" id="dateFilter" class="form-control" value="{{ default_date }}">
                        <button id="applyFilter" class="btn btn-primary mt-2">Apply</button>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Summary</h5>
                        <p>Total Messages: <strong id="totalMessages">0</strong></p>
                        <p>Date: <strong id="displayDate">{{ default_date }}</strong></p>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="alert alert-success">
                                    Sent: <strong id="sentCount">0</strong>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="alert alert-warning">
                                    Pending: <strong id="pendingCount">0</strong>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="alert alert-danger">
                                    Failed: <strong id="failedCount">0</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Charts -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Message Status Distribution</h5>
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">DLR Status Distribution</h5>
                        <canvas id="dlrChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Hourly Message Volume</h5>
                        <canvas id="hourlyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- DLR Trend Over Time -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">DLR Status Trend</h5>
                        <div class="btn-group mb-3" role="group">
                            <button type="button" class="btn btn-outline-primary active" id="dailyTrendBtn">Daily</button>
                            <button type="button" class="btn btn-outline-primary" id="weeklyTrendBtn">Weekly</button>
                            <button type="button" class="btn btn-outline-primary" id="monthlyTrendBtn">Monthly</button>
                        </div>
                        <canvas id="dlrTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Error Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Top Errors</h5>
                        <div class="table-responsive">
                            <table class="table table-striped" id="errorTable">
                                <thead>
                                    <tr>
                                        <th>Error Code</th>
                                        <th>Error Message</th>
                                        <th>DLR Status</th>
                                        <th>Count</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global chart variables
        let statusChart, hourlyChart, dlrChart, dlrTrendChart;
        let currentTrendView = "daily";
        
        // Initialize the page
        $(document).ready(function() {
            fetchData();
            
            // Set up filter button
            $('#applyFilter').click(function() {
                fetchData();
            });
            
            // Set up trend view buttons
            $('#dailyTrendBtn, #weeklyTrendBtn, #monthlyTrendBtn').click(function() {
                $('#dailyTrendBtn, #weeklyTrendBtn, #monthlyTrendBtn').removeClass('active');
                $(this).addClass('active');
                
                if ($(this).attr('id') === 'dailyTrendBtn') currentTrendView = "daily";
                else if ($(this).attr('id') === 'weeklyTrendBtn') currentTrendView = "weekly";
                else currentTrendView = "monthly";
                
                fetchTrendData();
            });
        });
        
        function fetchData() {
            const username = $('#username').text();
            const date = $('#dateFilter').val();
            
            $.get(`/api/analytics/?username=${username}&date=${date}`, function(data) {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                // Update summary
                $('#totalMessages').text(data.total_messages);
                $('#displayDate').text(data.selected_date);
                $('#sentCount').text(data.dlr_counts?.sent || 0);
                $('#pendingCount').text(data.dlr_counts?.pending || 0);
                $('#failedCount').text(data.dlr_counts?.failed || 0);
                
                // Update charts
                updateStatusChart(data.status_labels, data.status_counts);
                updateHourlyChart(data.hourly_labels, data.hourly_counts);
                updateDlrChart(data.dlr_labels, data.dlr_counts);
                
                // Update error table
                updateErrorTable(data.error_data);
                
                // Fetch trend data
                fetchTrendData();
            }).fail(function() {
                alert('Failed to fetch data. Please try again.');
            });
        }
        
        function fetchTrendData() {
            const username = $('#username').text();
            const date = $('#dateFilter').val();
            
            $.get(`/api/analytics/trend/?username=${username}&date=${date}&view=${currentTrendView}`, function(data) {
                if (data.error) {
                    console.error('Error fetching trend data:', data.error);
                    return;
                }
                
                updateDlrTrendChart(data.labels, data.sent_data, data.pending_data, data.failed_data);
            }).fail(function() {
                console.error('Failed to fetch trend data');
            });
        }
        
        function updateStatusChart(labels, data) {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            // Destroy previous chart if exists
            if (statusChart) {
                statusChart.destroy();
            }
            
            statusChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
        }
        
        function updateDlrChart(labels, data) {
            const ctx = document.getElementById('dlrChart').getContext('2d');
            
            // Destroy previous chart if exists
            if (dlrChart) {
                dlrChart.destroy();
            }
            
            dlrChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Sent', 'Pending', 'Failed'],
                    datasets: [{
                        data: [data.sent || 0, data.pending || 0, data.failed || 0],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.7)',  // green for sent
                            'rgba(255, 193, 7, 0.7)',  // yellow for pending
                            'rgba(220, 53, 69, 0.7)'   // red for failed
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
        }
        
        function updateHourlyChart(labels, data) {
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            
            // Destroy previous chart if exists
            if (hourlyChart) {
                hourlyChart.destroy();
            }
            
            hourlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Messages per hour',
                        data: data,
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Messages'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Hour of Day'
                            }
                        }
                    }
                }
            });
        }
        
        function updateDlrTrendChart(labels, sentData, pendingData, failedData) {
            const ctx = document.getElementById('dlrTrendChart').getContext('2d');
            
            // Destroy previous chart if exists
            if (dlrTrendChart) {
                dlrTrendChart.destroy();
            }
            
            dlrTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Sent',
                            data: sentData,
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: 'Pending',
                            data: pendingData,
                            backgroundColor: 'rgba(255, 193, 7, 0.1)',
                            borderColor: 'rgba(255, 193, 7, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: 'Failed',
                            data: failedData,
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            borderColor: 'rgba(220, 53, 69, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: `${currentTrendView.charAt(0).toUpperCase() + currentTrendView.slice(1)} DLR Status Trend`
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Message Count'
                            },
                            stacked: false
                        },
                        x: {
                            title: {
                                display: true,
                                text: currentTrendView === 'daily' ? 'Date' : 
                                      currentTrendView === 'weekly' ? 'Week' : 'Month'
                            }
                        }
                    }
                }
            });
        }
        
        function updateErrorTable(errorData) {
            const tbody = $('#errorTable tbody');
            tbody.empty();
            
            if (errorData.length === 0) {
                tbody.append('<tr><td colspan="4" class="text-center">No errors found</td></tr>');
                return;
            }
            
            errorData.forEach(error => {
                tbody.append(`
                    <tr>
                        <td>${error.error_code || 'N/A'}</td>
                        <td>${error.error_message || 'No message'}</td>
                        <td><span class="badge bg-${error.dlr_status === 'failed' ? 'danger' : 
                                              error.dlr_status === 'pending' ? 'warning' : 
                                              'success'}">${error.dlr_status || 'N/A'}</span></td>
                        <td>${error.count}</td>
                    </tr>
                `);
            });
        }
    </script>
</body>
</html>